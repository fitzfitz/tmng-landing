---
import BaseLayout from "@/layouts/base-layout.astro";
import { Container, Typography } from "@/components/ui";
import PostCard from "@/features/blog/post-card.astro";
import NewsletterForm from "@/features/blog/newsletter-form.tsx";

// Fetch data from API
const baseUrl = import.meta.env.DEV ? "http://localhost:4321" : "https://tmng.my.id";

// Fetch featured post
const featuredRes = await fetch(`${baseUrl}/api/posts/featured`);
const featuredData = await featuredRes.json();
const featuredPost = featuredData.data;

// Fetch regular posts
const postsRes = await fetch(`${baseUrl}/api/posts?limit=4`);
const postsData = await postsRes.json();
const posts = postsData.data ?? [];

// Fetch categories
const categoriesRes = await fetch(`${baseUrl}/api/categories`);
const categoriesData = await categoriesRes.json();
const categories = [
  { name: "All Topics", slug: "", count: categoriesData.total ?? 0, active: true },
  ...(categoriesData.data ?? []).map((cat: { name: string; slug: string; postCount: number }) => ({
    name: cat.name,
    slug: cat.slug,
    count: cat.postCount,
    active: false,
  })),
];

// Helper to format date
function formatDate(dateString: string | null) {
  if (!dateString) return "";
  return new Date(dateString).toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
    year: "numeric",
  });
}
---

<BaseLayout title="Blog | TMNG" description="Insights on web development, design, and digital strategy.">
  
  {/* Featured Post Section */}
  {featuredPost && (
    <section class="pt-32 pb-20 bg-white relative">
       <Container>
          <div class="mb-12">
              <Typography variant="caption" className="text-purple-600 mb-2">Featured Post</Typography>
              <Typography variant="h1" className="text-gray-900">Latest Insights</Typography>
          </div>

          {/* Featured Post Card */}
          <a href={`/blog/${featuredPost.slug}`} class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-center card-clean rounded-3xl p-8 lg:p-12 hover:shadow-2xl transition-shadow duration-500 cursor-pointer group">
              <div class="lg:col-span-7 h-64 lg:h-96 rounded-2xl overflow-hidden relative bg-linear-to-br from-purple-100 to-purple-200">
                  <div class="absolute inset-0 bg-purple-600/10 group-hover:bg-purple-600/20 transition-colors"></div>
                  <img 
                    src={featuredPost.coverImage || "/images/blog/default.png"} 
                    alt={featuredPost.title} 
                    class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-105" 
                  />
              </div>
              <div class="lg:col-span-5 flex flex-col justify-center">
                   <div class="flex items-center gap-3 mb-6">
                      {featuredPost.categories?.[0] && (
                        <span class="px-3 py-1 rounded-full text-xs font-bold bg-purple-600 text-white">
                            {featuredPost.categories[0].name}
                        </span>
                      )}
                      <span class="text-gray-600 text-sm">{formatDate(featuredPost.publishedAt)}</span>
                   </div>
                   <h2 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-6 leading-tight group-hover:text-purple-600 transition-colors">
                      {featuredPost.title}
                   </h2>
                   <p class="text-gray-700 text-lg leading-relaxed mb-8">
                      {featuredPost.excerpt}
                   </p>
                   <div class="flex items-center gap-4">
                       <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center text-purple-600 font-bold text-sm">
                          {featuredPost.author?.name?.substring(0, 2).toUpperCase() || "TM"}
                       </div>
                       <div>
                          <div class="text-gray-900 font-medium">{featuredPost.author?.name || "Team TMNG"}</div>
                          <div class="text-gray-600 text-xs">{featuredPost.readTimeMinutes || 5} min read</div>
                       </div>
                   </div>
              </div>
          </a>
       </Container>
    </section>
  )}

  {/* Light Content Body */}
  <section class="py-20 bg-slate-50 border-t border-black/5 min-h-[800px]">
    <Container>
        <div class="flex flex-col lg:flex-row gap-12">
            
            {/* Main Content - Grid */}
            <div class="w-full lg:w-2/3">
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    {posts.map((post: {
                      slug: string;
                      title: string;
                      excerpt: string;
                      coverImage: string | null;
                      publishedAt: string | null;
                      readTimeMinutes: number | null;
                      categories: { name: string }[];
                      author: { name: string } | null;
                    }) => (
                      <PostCard 
                        title={post.title}
                        excerpt={post.excerpt || ""}
                        date={formatDate(post.publishedAt)}
                        category={post.categories?.[0]?.name || "General"}
                        slug={post.slug}
                        image={post.coverImage || "/images/blog/default.png"}
                        author={{ 
                          name: post.author?.name || "Team TMNG", 
                          avatar: (post.author?.name || "TM").substring(0, 2).toUpperCase() 
                        }}
                        readTime={`${post.readTimeMinutes || 5} min read`}
                        variant="light" 
                      />
                    ))}
                </div>
                
                {/* Pagination */}
                {postsData.pagination?.hasMore && (
                  <div class="mt-16 flex justify-center">
                      <button 
                        id="load-more-btn"
                        data-page="2"
                        class="px-6 py-3 rounded-full border border-slate-200 text-slate-600 font-medium hover:bg-white hover:shadow-md transition-all"
                      >
                          Load More Articles
                      </button>
                  </div>
                )}
            </div>

            {/* Sticky Sidebar */}
            <div class="w-full lg:w-1/3 lg:pl-12">
                <div class="sticky top-32 space-y-12">
                    
                    {/* Search */}
                    <div class="relative">
                        <input 
                            type="text" 
                            id="search-input"
                            placeholder="Search articles..." 
                            class="w-full pl-12 pr-4 py-4 rounded-2xl bg-white border border-gray-200 text-gray-800 focus:outline-none focus:ring-2 focus:ring-purple-500/20 focus:border-purple-500 transition-all shadow-sm"
                        />
                        <svg class="w-5 h-5 text-slate-400 absolute left-4 top-1/2 -translate-y-1/2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>

                    {/* Categories */}
                    <div>
                        <h3 class="text-lg font-bold text-slate-900 mb-6">Explore Topics</h3>
                        <div class="space-y-2">
                            {categories.map((cat) => (
                                <a 
                                  href={cat.slug ? `/blog?category=${cat.slug}` : "/blog"}
                                  class={`w-full flex items-center justify-between px-4 py-3 rounded-xl transition-all ${
                                    cat.active 
                                    ? "bg-purple-600 text-white shadow-lg" 
                                    : "bg-white text-gray-600 hover:bg-gray-100 border border-gray-100"
                                }`}>
                                   <span class="font-medium">{cat.name}</span>
                                   <span class={`text-xs px-2 py-0.5 rounded-full ${cat.active ? "bg-white/20 text-white" : "bg-gray-100 text-gray-400"}`}>
                                       {cat.count}
                                   </span>
                                </a>
                            ))}
                        </div>
                    </div>

                    {/* Newsletter */}
                    <div class="bg-purple-600 rounded-3xl p-8 relative overflow-hidden">
                        <div class="relative z-10">
                            <h3 class="text-xl font-bold text-white mb-2">Weekly Digest</h3>
                            <p class="text-purple-100 text-sm mb-6">Get the latest tech trends in your inbox. No spam, just value.</p>
                            <NewsletterForm client:visible />
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </Container>
  </section>
</BaseLayout>

<script>
  // Search functionality
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  if (searchInput) {
    let debounceTimer: number;
    searchInput.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = window.setTimeout(async () => {
        const query = searchInput.value.trim();
        if (query.length >= 2) {
          window.location.href = `/blog?search=${encodeURIComponent(query)}`;
        }
      }, 500);
    });
  }
</script>
