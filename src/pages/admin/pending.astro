---
import BaseLayout from "@/layouts/base-layout.astro";
import { Container } from "@/components/ui";
import { handleSignOut } from "@/lib/auth-client";

// Get session
const baseUrl = import.meta.env.DEV ? "http://localhost:4321" : "https://tmng.my.id";
const sessionRes = await fetch(`${baseUrl}/api/session`, {
  headers: {
    cookie: Astro.request.headers.get("cookie") || "",
  },
});
const sessionData = await sessionRes.json();

// Redirect if not logged in or already approved
if (!sessionData.user) {
  return Astro.redirect("/admin/login");
}

if (sessionData.user.role !== "pending") {
  return Astro.redirect("/admin");
}

const user = sessionData.user;
---

<BaseLayout title="Pending Approval | TMNG Admin" description="Your account is pending approval." showNav={false}>
  <section class="min-h-screen flex items-center justify-center py-20">
    <Container className="max-w-md">
      <div class="glass-card-strong rounded-3xl p-10 text-center">
        {/* Avatar */}
        <div class="mb-6">
          {user.image ? (
            <img 
              src={user.image} 
              alt={user.name} 
              class="w-20 h-20 rounded-full mx-auto border-4 border-fuchsia-500/30"
            />
          ) : (
            <div class="w-20 h-20 rounded-full bg-fuchsia-500/20 flex items-center justify-center mx-auto text-fuchsia-300 text-3xl font-bold">
              {user.name?.charAt(0).toUpperCase() || "U"}
            </div>
          )}
        </div>

        {/* Message */}
        <h1 class="text-2xl font-bold text-white mb-2">
          Hi, {user.name}! ðŸ‘‹
        </h1>
        <p class="text-purple-200/70 mb-6">
          Your account is pending approval. An administrator will review your request soon.
        </p>

        {/* Status */}
        <div class="inline-flex items-center gap-2 px-4 py-2 bg-yellow-500/10 rounded-xl mb-6">
          <div class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></div>
          <span class="text-yellow-300 text-sm font-medium">Pending Approval</span>
        </div>

        {/* Info */}
        <div class="bg-white/5 rounded-xl p-4 mb-6 text-left">
          <p class="text-purple-200/60 text-sm">
            <strong class="text-white">Email:</strong> {user.email}
          </p>
        </div>

        {/* Sign out */}
        <button
          id="sign-out-btn"
          class="w-full px-6 py-3 bg-white/10 text-white font-medium rounded-xl hover:bg-white/20 transition-colors"
        >
          Sign Out
        </button>
      </div>
    </Container>
  </section>
</BaseLayout>

<script>
  import { handleSignOut } from "@/lib/auth-client";
  
  const btn = document.getElementById("sign-out-btn");
  btn?.addEventListener("click", () => {
    handleSignOut();
  });
</script>
