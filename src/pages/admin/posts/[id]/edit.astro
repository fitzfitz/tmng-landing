---
import BaseLayout from "@/layouts/base-layout.astro";
import AdminLayout from "@/features/admin/admin-layout";
import PostEditor from "@/features/admin/post-editor";

const { id } = Astro.params;

// Check session
const user = Astro.locals.user;
const baseUrl = import.meta.env.DEV ? "http://localhost:4321" : "https://tmng.my.id";

if (!user) {
  return Astro.redirect("/admin/login");
}

if (!id) {
  return Astro.redirect("/admin/posts");
}

// Fetch post data server-side
let post = null;
try {
  const res = await fetch(`${baseUrl}/api/admin/posts/${id}`, {
    headers: {
      cookie: Astro.request.headers.get("cookie") || "",
    },
  });
  
  const data = await res.json();
  if (data.data) {
    post = data.data;
  }
} catch (error) {
  console.error("Failed to load post:", error);
}

if (!post) {
  return Astro.redirect("/admin/posts");
}
---

<BaseLayout title={`Edit ${post.title} | Admin Dashboard`} showNav={false}>
  <AdminLayout user={user} currentPath="/admin/posts" client:load>
    <div class="p-6">
      <div class="mb-6">
        <div class="flex items-center gap-2 text-sm text-purple-200/50 mb-2">
          <a href="/admin/posts" class="hover:text-fuchsia-400 transition-colors">Posts</a>
          <span>/</span>
          <span class="text-fuchsia-400">Edit Post</span>
        </div>
      </div>

      <PostEditor initialData={post} client:only="react" />
    </div>
  </AdminLayout>
</BaseLayout>
